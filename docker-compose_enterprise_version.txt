services:
  # Oracle Database 23ai Enterprise (Source) - ARM64 Native with Integrated Extract Support
  oracle-enterprise:
    #image: container-registry.oracle.com/database/free:23.6
    #image: container-registry.oracle.com/database/free@sha256:cd2778b58358bb936015843d45fd277a199d055d5daae8a79b63f7b4073eeeb9
    image: container-registry.oracle.com/database/enterprise:21.3.0.0
    platform: linux/amd64
    container_name: oracle-enterprise
    hostname: oracle-enterprise
    environment:
      - ORACLE_PWD=Oracle123!
      - ORACLE_CHARACTERSET=AL32UTF8
      - ORACLE_SID=ORAEEV213
      - ORACLE_PDB=EXTRACTPDB1
      - INIT_SGA_SIZE=2048
      - INIT_PGA_SIZE=1024
    ports:
      - "127.10.0.1:1521:1521"
      - "127.10.0.1:5500:5500"
    volumes:
      - oracle_enterprise_data:/opt/oracle/oradata
      - ./scripts/oracle-enterprise:/opt/oracle/scripts/setup
      - ./configs/oracle-enterprise:/opt/oracle/scripts/configs
      - ./logs/oracle-enterprise:/opt/oracle/diag
    networks:
      - gg-network
    healthcheck:
      test: ["CMD-SHELL", "echo 'select 1 from dual;' | sqlplus -s sys/Oracle123!@localhost:1521/EXTRACTPDB1 as sysdba | grep -q 1"]
      timeout: 45s
      retries: 12
      start_period: 90s  # 
      interval: 30s
    shm_size: 2g  # Required for proper Oracle performance
  #  command: ["/opt/oracle/runOracle.sh"]

  # PostgreSQL Database (Target)
  postgresql-target:
    image: postgres:15
    container_name: postgresql
    hostname: postgresql
    environment:
      - POSTGRES_DB=postgresdb
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=Postgres123!
      - PGDATA=/var/lib/postgresql/data/pgdata
    ports:
      - "127.10.0.2:5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/postgresql:/docker-entrypoint-initdb.d
      - ./configs/postgresql:/etc/postgresql
      - ./logs/postgresql:/var/log/postgresql
    networks:
      - gg-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgresdb"]
      timeout: 10s
      retries: 5
      start_period: 30s
      interval: 10s

  # GoldenGate Microservices - Extract (Oracle Source)
  gg-extract:
    image: container-registry.oracle.com/goldengate/goldengate-oracle-free:latest
    platform: linux/amd64  # Force AMD64 emulation on ARM64 Mac
    container_name: gg-extract
    hostname: gg-extract
    environment:
      - OGG_DEPLOYMENT=OracleExtract
      - OGG_ADMIN_PWD=GGAdmin123!
      - OGG_SECURE=false
      - OGG_EDITION=standard
      - OGG_SERVER_TYPE=microservices
    ports:
      - "127.10.0.4:9100:80"    # ServiceManager Web UI (corrected)
      - "127.10.0.4:9011:9011"  # Distribution service port
    volumes:
      - gg_extract_data:/opt/oracle/ogg/var
      - ./configs/gg-extract:/opt/oracle/ogg/dirprm
      - ./scripts/gg-extract:/opt/oracle/ogg/scripts
      - ./logs/gg-extract:/opt/oracle/ogg/var/logs
    networks:
      - gg-network
    healthcheck:
      test: ["CMD-SHELL", "curl -sfL http://localhost:80/OracleExtract/services/v2/about >/dev/null"]
      start_period: 320s
      interval: 30s
      timeout: 15s
      retries: 12
  
  # GoldenGate Microservices - Replicat (PostgreSQL Target)
  gg-replicat:
    image: container-registry.oracle.com/goldengate/goldengate-postgresql-free:latest
    platform: linux/amd64  # Force AMD64 emulation on ARM64 Mac
    container_name: gg-replicat
    hostname: gg-replicat
    environment:
      - OGG_DEPLOYMENT=PostgreSQLReplicat
      - OGG_ADMIN_PWD=GGAdmin123!
      - OGG_SECURE=false
      - OGG_EDITION=standard
      - OGG_SERVER_TYPE=microservices
    ports:
      - "127.10.0.3:9200:80"    # ServiceManager Web UI (corrected)
      - "127.10.0.3:9021:9021"  # Receiver service port
    volumes:
      - gg_replicat_data:/opt/oracle/ogg/var
      - ./configs/gg-replicat:/opt/oracle/ogg/dirprm
      - ./scripts/gg-replicat:/opt/oracle/ogg/scripts
      - ./logs/gg-replicat:/opt/oracle/ogg/var/logs
    networks:
      - gg-network
    healthcheck:
      test: ["CMD-SHELL", "curl -sfL http://localhost:80/PostgreSQLReplicat/services/v2/about >/dev/null"]
      start_period: 320s
      interval: 30s
      timeout: 15s
      retries: 12


  # pgAdmin for PostgreSQL management
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin
    hostname: pgadmin
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@example.com
      - PGADMIN_DEFAULT_PASSWORD=admin123
      - PGADMIN_CONFIG_SERVER_MODE=False
    ports:
      - "127.10.0.7:8080:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - gg-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/misc/ping"]
      timeout: 10s
      retries: 3
      start_period: 30s
      interval: 30s

volumes:
  oracle_enterprise_data:
    driver: local
  postgres_data:
    driver: local
  gg_extract_data:
    driver: local
  gg_replicat_data:
    driver: local
  pgadmin_data:
    driver: local

networks:
  gg-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
